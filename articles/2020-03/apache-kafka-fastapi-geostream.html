<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Apache Kafka producer and consumer with FastAPI and aiokafka" /><meta name="author" content="iwpnd" /><meta property="og:locale" content="en_US" /><meta name="description" content="After I finally published flashgeotext last month, it was time for the next item on the to-do list - Apache Kafka. After I somehow avoided the topic completely for the last years, aside from that one friend that wouldn’t shut up about it, I noticed that more often than not Apache Kafka knowledge is a requirement for a lot of positions in data engineering nowadays. So I did what I recommand everybody starting out - check out Tim Berglund’s introduction on Apache Kafka on YouTube and skinny-dip into the rabbit hole from there." /><meta property="og:description" content="After I finally published flashgeotext last month, it was time for the next item on the to-do list - Apache Kafka. After I somehow avoided the topic completely for the last years, aside from that one friend that wouldn’t shut up about it, I noticed that more often than not Apache Kafka knowledge is a requirement for a lot of positions in data engineering nowadays. So I did what I recommand everybody starting out - check out Tim Berglund’s introduction on Apache Kafka on YouTube and skinny-dip into the rabbit hole from there." /><link rel="canonical" href="https://iwpnd.pw//articles/2020-03/apache-kafka-fastapi-geostream" /><meta property="og:url" content="https://iwpnd.pw//articles/2020-03/apache-kafka-fastapi-geostream" /><meta property="og:site_name" content="iwpnd" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-03-11T11:37:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Apache Kafka producer and consumer with FastAPI and aiokafka" /><meta name="twitter:site" content="@imwithpanda" /><meta name="twitter:creator" content="@imwithpanda" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"iwpnd"},"dateModified":"2020-03-11T11:37:00+00:00","datePublished":"2020-03-11T11:37:00+00:00","description":"After I finally published flashgeotext last month, it was time for the next item on the to-do list - Apache Kafka. After I somehow avoided the topic completely for the last years, aside from that one friend that wouldn’t shut up about it, I noticed that more often than not Apache Kafka knowledge is a requirement for a lot of positions in data engineering nowadays. So I did what I recommand everybody starting out - check out Tim Berglund’s introduction on Apache Kafka on YouTube and skinny-dip into the rabbit hole from there.","headline":"Apache Kafka producer and consumer with FastAPI and aiokafka","mainEntityOfPage":{"@type":"WebPage","@id":"https://iwpnd.pw//articles/2020-03/apache-kafka-fastapi-geostream"},"url":"https://iwpnd.pw//articles/2020-03/apache-kafka-fastapi-geostream"}</script><title> Apache Kafka producer and consumer with FastAPI and aiokafka - iwpnd</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="iwpnd" href="/atom.xml"><link rel="alternate" type="application/json" title="iwpnd" href="https://iwpnd.pw//feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.highlight{background:#282a36;color:#f8f8f2;font-size:.8rem}.highlight .hll,.highlight .s,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .dl,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx,.highlight .sr,.highlight .s1,.highlight .ss{color:#f1fa8c}.highlight .go{color:#44475a}.highlight .err,.highlight .g,.highlight .l,.highlight .n,.highlight .x,.highlight .p,.highlight .ge,.highlight .gr,.highlight .gh,.highlight .gi,.highlight .gp,.highlight .gs,.highlight .gu,.highlight .gt,.highlight .ld,.highlight .no,.highlight .nd,.highlight .ni,.highlight .ne,.highlight .nn,.highlight .nx,.highlight .py,.highlight .w,.highlight .bp{color:#f8f8f2}.highlight .gh,.highlight .gi,.highlight .gu{font-weight:bold}.highlight .ge{text-decoration:underline}.highlight .bp{font-style:italic}.highlight .c,.highlight .ch,.highlight .cm,.highlight .cpf,.highlight .c1,.highlight .cs{color:#6272a4}.highlight .kd,.highlight .kt,.highlight .nb,.highlight .nl,.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#8be9fd}.highlight .kd,.highlight .nb,.highlight .nl,.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{font-style:italic}.highlight .na,.highlight .nc,.highlight .nf,.highlight .fm{color:#50fa7b}.highlight .k,.highlight .o,.highlight .cp,.highlight .kc,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .nt,.highlight .ow{color:#ff79c6}.highlight .m,.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#bd93f9}.highlight .gd{color:#f55}</style></head><body><main role="main"><header role="banner"> <img src="/img/iwpnd-logo.png" alt="iwpnd logo"><nav role="navigation"><ul><li><a href="/" >blog</a></li><li><a href="/til" >til</a></li><li><a href="/about" >about</a></li><li><a href="/search" >search</a></li><li><a href="/imprint" >imprint</a></li></ul></nav></header><script async src="https://www.googletagmanager.com/gtag/js?id=UA-156087226-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-156087226-1'); </script><section class="post"><h2>Apache Kafka producer and consumer with FastAPI and aiokafka</h2><p>After I finally published <a href="https://iwpnd.pw/articles/2020-02/flashgeotext-library">flashgeotext</a> last month, it was time for the next item on the to-do list - Apache Kafka. After I somehow avoided the topic completely for the last years, aside from that one friend that wouldn’t shut up about it, I noticed that more often than not Apache Kafka knowledge is a requirement for a lot of positions in data engineering nowadays. So I did what I recommand everybody starting out - check out <a href="https://www.youtube.com/watch?v=06iRM1Ghr1k">Tim Berglund’s introduction on Apache Kafka</a> on YouTube and skinny-dip into the rabbit hole from there.</p><h1 id="tldr">tl;dr</h1><p>Find the finished project on GitHub: <a href="https://github.com/iwpnd/geo-stream-kafka">geo-stream-kafka</a></p><h1 id="what-is-apache-kafka">What is Apache Kafka?</h1><p>Always great to read an introduction into a complex topic from somebody who just recently started out with it, right? What could go wrong. So in its core, Apache Kafka is a messaging system with somebody/something producing a message on the one side and a somebody/something consuming the message on the other side, and a lot of magic in between.</p><h2 id="kafka-core-principles">Kafka core principles</h2><p>To zoom in on the magic part, when a producer sends a message, the message is pushed into Kafka topics. When a consumer consumes a message it is pulling the message from a Kafka topic. Kafka topics reside within a so-called broker (eg. Zookeeper). Zookeeper provides synchronization within distributed systems and in the case of Apache Kafka keeps track of the status of Kafka cluster nodes and Kafka topics.</p><p align="center"> <img src="/img/2020-03-geostream-kafka/kafka.png" alt="setup geostream FastAPI aiokafka" /></p><p>You can have multiple producers pushing messages into one topic, or you can have them push to different topics. Messages within topics can be retained indefinitly or be discarded after a certain time, depending on the needs. When a consumer starts consuming a message, it starts from the first message that has been pushed to the topic and continues from thereon. Kafka stores the so-called <em>offset</em>, basically a pointer telling the consumer which messages have been consumed and what is still left to indulge. Messages will stay within the topic, yet when the same consumer pulls messages from the topic it will only receive messages from the offset onwards.</p><p>There is actually a lot more to dissect here, but if you want to understand as much Apache Kafka to be dangerous, I’d say we leave it at that and I direct you to more competent, no less handsome, people to tell you more.</p><h1 id="master-builders-assemble">master builders assemble</h1><p>Okay, we have the theory let’s build something with it. This time, instead of a <a href="https://iwpnd.pw/articles/2020-02/flashgeotext-library">niche NLP problem</a> I wanted to go back to my origins as a geospatial engineer. I figured I would build a producer/consumer architecture for geodata. We will have a FastAPI endpoint that will wrap the producer logic and a consumer FastAPI WebSocket endpoint that a <a href="https://leafletjs.com/">leaflet.js</a> map-application then can tap into. So far I have used Leaflet.js to display static data, so why not try and use it with dynamic data instead. What I had in mind was an architecture like that:</p><p align="center"> <img src="/img/2020-03-geostream-kafka/geostream-FastAPI-kafka.png" alt="setup geostream FastAPI aiokafka" /></p><h2 id="setup-an-apache-kafka-cluster">Setup an Apache Kafka cluster</h2><p>Hell no, I would never dare to even try to comprehend what’s necessary to build that up from scratch. BUT, we live in different times now and there is that handsome technology called Docker. We also can be thankful that respective members of the interwebs community like <a href="https://github.com/wurstmeister/">wurstmeister</a> (german for Saugagemaster) prepare containers like <a href="https://github.com/wurstmeister/kafka-docker">Kafka-docker</a> that are ready to be used for you local (maybe more?) development entertainment. Now I will say that even that container didn’t come without troubles for me. I just wasn’t able to connect to the Kafka broker from outside the container. There is <a href="https://github.com/wurstmeister/kafka-docker/wiki">wurstmeisters kafka connectivity guide</a> that helped me to shed some light on the networking inside, but it didn’t help me to get a connection from the outside. The docs suggest that you add</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>environment:
      KAFKA_ADVERTISED_HOST_NAME: <span class="nb">hostname
      </span>KAFKA_CREATE_TOPICS: <span class="s2">"geostream:1:1"</span>
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
</code></pre></div></div><p>to your docker-compose file. There are three things to unpack. We can create the Kafka Topic right here and give it 1 partition and 1 replica. We connect Kafka container to the zookeeper container. Now to the connection problem. So I thought that I wanted to advertise Kafka to <code class="language-plaintext highlighter-rouge">localhost</code>. Yet it took me some time to understand why that would not be possible. See, what I learned is that Docker on Mac sets up a VM (yaya old news blabla), so <code class="language-plaintext highlighter-rouge">localhost</code> for Kafka inside its container is not your localhost but the IP of the VM your Kafka is running in. So I added this to my <code class="language-plaintext highlighter-rouge">.zshenv</code> file:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">DOCKER_KAFKA_HOST</span><span class="o">=</span><span class="si">$(</span>ipconfig getifaddr en0<span class="si">)</span>
</code></pre></div></div><p>and was able to advertise the hostname like so:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>environment:
      KAFKA_ADVERTISED_HOST_NAME: <span class="k">${</span><span class="nv">DOCKER_KAFKA_HOST</span><span class="k">}</span>
</code></pre></div></div><p>et voila, it’s alive!</p><h2 id="test-the-apache-kafka-cluster">Test the Apache Kafka cluster</h2><p>Wait, how do we know it’s alive and taking messages? We create a minimum viable Kafka producer and a minimum viable Kafka consumer, spin up to terminals and fire the up the producer and the consumer.</p><h3 id="setup-a-minimum-viable-producer">Setup a minimum viable producer</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pykafka</span> <span class="kn">import</span> <span class="n">KafkaClient</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">KafkaClient</span><span class="p">(</span><span class="s">"127.0.0.1:9092"</span><span class="p">)</span>
<span class="n">geostream</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">topcis</span><span class="p">[</span><span class="s">"geostream"</span><span class="p">]</span>

<span class="k">with</span> <span class="n">geostream</span><span class="p">.</span><span class="n">get_sync_producer</span><span class="p">()</span> <span class="k">as</span> <span class="n">producer</span><span class="p">:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">producer</span><span class="p">.</span><span class="n">produce</span><span class="p">((</span><span class="s">"Kafka is not just an author "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">"ascii"</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div><h3 id="setup-a-minimum-viable-consumer">Setup a minimum viable consumer</h3><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pykafka</span> <span class="kn">import</span> <span class="n">KafkaClient</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">KafkaClient</span><span class="p">(</span><span class="n">hosts</span><span class="o">=</span><span class="s">"127.0.0.1:9092"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_messages</span><span class="p">(</span><span class="n">topicname</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">events</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="p">.</span><span class="n">topics</span><span class="p">[</span><span class="n">topicname</span><span class="p">].</span><span class="n">get_simple_consumer</span><span class="p">():</span>
            <span class="k">yield</span> <span class="sa">f</span><span class="s">"i.value.decode()"</span>
            
    <span class="k">return</span> <span class="n">events</span><span class="p">()</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">get_messages</span><span class="p">(</span><span class="s">"geostream"</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div></div><p>If you see your consumer printing out what the producer is pushing, you’re good to go. If you set up your networking incorrectly, then you will notice it at this stage at the latest.</p><h2 id="fastapi-apache-kafka-producer">FastAPI Apache Kafka producer</h2><p>As shown in my sketch I want to wrap the producer into a <a href="https://FastAPI.tiangolo.com/">FastAPI</a> endpoint. This allows for more than one entity at a time to produce messages to a topic, but also enables me to flexibly change topics that I want to produce messages to with <a href="https://FastAPI.tiangolo.com/tutorial/path-params-numeric-validations/">FastAPI</a> endpoint path parameters. I opted to use <a href="https://github.com/aio-libs/aiokafka">aiokafka</a> instead of pykafka to make use of FastAPIs async capabilities, but also to plague myself and get a better understanding of async programming (still pending).</p><p>FastAPIs <code class="language-plaintext highlighter-rouge">on_event("startup)</code> and <code class="language-plaintext highlighter-rouge">on_event("shutdown")</code> make the use of a aiokafka producer easy.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>
<span class="n">aioproducer</span> <span class="o">=</span> <span class="n">AIOKafkaProducer</span><span class="p">(</span>
    <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="n">PROJECT_NAME</span><span class="p">,</span> <span class="n">bootstrap_servers</span><span class="o">=</span><span class="n">KAFKA_INSTANCE</span>
<span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">on_event</span><span class="p">(</span><span class="s">"startup"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">startup_event</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">aioproducer</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">on_event</span><span class="p">(</span><span class="s">"shutdown"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">shutdown_event</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">aioproducer</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
</code></pre></div></div><p>Afterwards we can use the <code class="language-plaintext highlighter-rouge">aioproducer</code> in our application.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="s">"/producer/{topicname}"</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">kafka_produce</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="n">ProducerMessage</span><span class="p">,</span> <span class="n">topicname</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">aioproducer</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">topicname</span><span class="p">,</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="nb">dict</span><span class="p">()).</span><span class="n">encode</span><span class="p">(</span><span class="s">"ascii"</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">ProducerResponse</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">message_id</span><span class="o">=</span><span class="n">msg</span><span class="p">.</span><span class="n">message_id</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="n">topicname</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div><h2 id="fastapi-apache-kafka-consumer">FastAPI Apache Kafka consumer</h2><p>The Apache Kafka consumer endpoint with FastAPI turned out to be a completely different beast. I wasn’t able to setup up something similar to the <code class="language-plaintext highlighter-rouge">pykafka</code> MVP. In <a href="">Flask</a> you can do something like and push server sent events to whoever is calling the <code class="language-plaintext highlighter-rouge">/consumer/&lt;topicname&gt;</code> endpoint:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/consumer/&lt;topicname&gt;'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_messages</span><span class="p">(</span><span class="n">topicname</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">events</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">client</span><span class="p">.</span><span class="n">topics</span><span class="p">[</span><span class="n">topicname</span><span class="p">].</span><span class="n">get_simple_consumer</span><span class="p">():</span>
            <span class="k">yield</span> <span class="sa">f</span><span class="s">"i.value.decode()"</span>
    
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">events</span><span class="p">(),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s">"text/event-stream"</span><span class="p">)</span>
</code></pre></div></div><p>This way we can in the Leaflet application we can add an <a href="https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events">EventSource and an EventListener</a> that would take incoming events and do something with it - exactly as we wanted it to be in the first place (see architecture). I was not able to do the same with FastAPI and an async generator. That is not to say it is not possible, but my dumb ass wasn’t able to figure out how and didn’t bother to open an issue with FastAPI.</p><p>What I did figure out, however, is that there is a beautiful thing called <a href="https://FastAPI.tiangolo.com/advanced/websockets/">Websockets</a> and that FastAPI happily supports the likes. Since FastAPI is built on-top of starlette we can use class-basedd endpoints and especially the <a href="https://www.starlette.io/endpoints/#websocketendpoint">WebsocketEndpoint</a> to handle incoming <code class="language-plaintext highlighter-rouge">Websocket</code> Sessions.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">websocket_route</span><span class="p">(</span><span class="s">"/consumer/{topicname}"</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">WebsocketConsumer</span><span class="p">(</span><span class="n">WebSocketEndpoint</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>

        <span class="c1"># get topicname from path until I have an alternative
</span>        <span class="n">topicname</span> <span class="o">=</span> <span class="n">websocket</span><span class="p">[</span><span class="s">"path"</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">"/"</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> 

        <span class="k">await</span> <span class="n">websocket</span><span class="p">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">websocket</span><span class="p">.</span><span class="n">send_json</span><span class="p">({</span><span class="s">"Message"</span><span class="p">:</span> <span class="s">"connected"</span><span class="p">})</span>

        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">consumer</span> <span class="o">=</span> <span class="n">AIOKafkaConsumer</span><span class="p">(</span>
            <span class="n">topicname</span><span class="p">,</span>
            <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span>
            <span class="n">client_id</span><span class="o">=</span><span class="n">PROJECT_NAME</span><span class="p">,</span>
            <span class="n">bootstrap_servers</span><span class="o">=</span><span class="n">KAFKA_INSTANCE</span><span class="p">,</span>
            <span class="n">enable_auto_commit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">consumer</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">consumer_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="p">.</span><span class="n">create_task</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">send_consumer_message</span><span class="p">(</span><span class="n">websocket</span><span class="o">=</span><span class="n">websocket</span><span class="p">,</span> <span class="n">topicname</span><span class="o">=</span><span class="n">topicname</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"connected"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">close_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">consumer_task</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="p">.</span><span class="n">consumer</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s">"counter: </span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">counter</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"disconnected"</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s">"consumer stopped"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">on_receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">typing</span><span class="p">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">websocket</span><span class="p">.</span><span class="n">send_json</span><span class="p">({</span><span class="s">"Message"</span><span class="p">:</span> <span class="n">data</span><span class="p">})</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">send_consumer_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">websocket</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">topicname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">consume</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">consumer</span><span class="p">,</span> <span class="n">topicname</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">ConsumerResponse</span><span class="p">(</span><span class="n">topic</span><span class="o">=</span><span class="n">topicname</span><span class="p">,</span> <span class="o">**</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="n">logger</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">websocket</span><span class="p">.</span><span class="n">send_text</span><span class="p">(</span><span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span>
</code></pre></div></div><p>When an application starts a websocket connection with out websocket endpoint we grab the event loop, use that to build and start the aiokafka consumer, start it and start a consumer task in the loop. Once this is set, everytime the consumer pulls a new message it is forwarded to the application through the websocket. When the leafletjs application either specifically closes the websocket or the browser is closed, we close the websocket, cancel the consumer_task and stop the consumer.</p><h2 id="leaflet-application">Leaflet application</h2><p>I have to admit that it’s been some time that I have touched JavaScript at all, so bare with me here.</p><p>First we will declare our map and websocket connection to the <code class="language-plaintext highlighter-rouge">/consumer/{topicname}</code> endpoint.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">L</span><span class="p">.</span><span class="nb">Map</span><span class="p">(</span><span class="dl">'</span><span class="s1">map</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">linesLayer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">L</span><span class="p">.</span><span class="nx">LayerGroup</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="dl">"</span><span class="s2">ws://127.0.0.1:8003/consumer/geostream</span><span class="dl">"</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">osmUrl</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">osmAttribution</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">&amp;copy; &lt;a href="https://www.openstreetmap.org/copyright"&gt;OpenStreetMap&lt;/a&gt; contributors &amp;copy; &lt;a href="https://carto.com/attributions"&gt;CARTO&lt;/a&gt;</span><span class="dl">'</span><span class="p">,</span>
    <span class="nx">osm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">L</span><span class="p">.</span><span class="nx">tileLayer</span><span class="p">(</span><span class="nx">osmUrl</span><span class="p">,</span> <span class="p">{</span><span class="na">maxZoom</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="na">attribution</span><span class="p">:</span> <span class="nx">osmAttribution</span><span class="p">});</span>

<span class="kd">var</span> <span class="nx">colors</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">#8be9fd</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">#50fa7b</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">#ffb86c</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">#ff79c6</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">#bd93f9</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">#ff5555</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">#f1fa8c</span><span class="dl">"</span><span class="p">];</span>
<span class="nx">lines</span> <span class="o">=</span> <span class="p">{};</span>
</code></pre></div></div><p>When client and backend established the silent agreement to use WebSockets, we can declare what we want to do, whenever the <a href="https://javascript.info/websocket">websocket receives a new message</a>. Every message is an <code class="language-plaintext highlighter-rouge">event</code>. And every <code class="language-plaintext highlighter-rouge">event</code> consists of metadata and <code class="language-plaintext highlighter-rouge">event.data</code> that can be parsed with <code class="language-plaintext highlighter-rouge">JSON.parse()</code>.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="nx">obj</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>

    <span class="p">[...]</span>
</code></pre></div></div><p>One of the requirements was to display more than one entity that pushes messages through the producer, Kafka and the consumer on the map as a live-event. For the leaflet application to associate an event to an entity, I hash events by the name of the entity that is sending them. If there is a new <code class="language-plaintext highlighter-rouge">name</code> in an event, it’ll be hashed into a dictionary and added as a new layer on the map. As I wanted every entity to be represented with a different color, the color will be randomly grabbed from the list of <code class="language-plaintext highlighter-rouge">colors</code> and hashed alongside the position of the event/entity.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">[...]</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="nx">lines</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">lines</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">latlon</span><span class="dl">"</span><span class="p">:</span> <span class="p">[]};</span>
      <span class="nx">lines</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="dl">"</span><span class="s2">latlon</span><span class="dl">"</span><span class="p">].</span><span class="nx">push</span><span class="p">([</span><span class="nx">obj</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">lon</span><span class="p">]);</span>
      <span class="nx">lines</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="dl">"</span><span class="s2">config</span><span class="dl">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="dl">"</span><span class="s2">color</span><span class="dl">"</span><span class="p">:</span> <span class="nx">colors</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">)]};</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">lines</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="dl">"</span><span class="s2">latlon</span><span class="dl">"</span><span class="p">].</span><span class="nx">push</span><span class="p">([</span><span class="nx">obj</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">lon</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nx">line</span> <span class="o">=</span> <span class="nx">L</span><span class="p">.</span><span class="nx">polyline</span><span class="p">(</span><span class="nx">lines</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="dl">"</span><span class="s2">latlon</span><span class="dl">"</span><span class="p">],</span> <span class="p">{</span><span class="na">color</span><span class="p">:</span> <span class="nx">lines</span><span class="p">[</span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span><span class="p">][</span><span class="dl">"</span><span class="s2">config</span><span class="dl">"</span><span class="p">][</span><span class="dl">"</span><span class="s2">color</span><span class="dl">"</span><span class="p">]})</span>
    <span class="nx">linesLayer</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
    <span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">(</span><span class="nx">linesLayer</span><span class="p">);</span>

<span class="p">};</span>
</code></pre></div></div><p>On thing to keep in mind is, that when you zoom on the map the <code class="language-plaintext highlighter-rouge">bounds</code> will be messed up and the events will not properly draw polylines along the trajectory of the entity. To fix this I added an <code class="language-plaintext highlighter-rouge">zoomend</code> trigger:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">zoomend</span><span class="dl">"</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">linesLayer</span><span class="p">.</span><span class="nx">clearLayers</span><span class="p">()</span> <span class="p">});</span>
</code></pre></div></div><p>that will clear the layers until the next event arrives and then continues to draw the trajectories.</p><h2 id="result">Result</h2><p align="center"> <img src="/img/2020-03-geostream-kafka/geostream.gif" alt="geostream leaflet" /></p><span class="meta"><time datetime="2020-03-11T11:37:00+00:00">March 11, 2020</time> &middot; <a href="/tag/python">python</a>, <a href="/tag/kafka">kafka</a>, <a href="/tag/FastAPI">FastAPI</a></span></section></main></body></html>
