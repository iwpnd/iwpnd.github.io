<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Docker Swarm on AWS EC2 Part 1: Initial provisioning and setup" /><meta name="author" content="iwpnd" /><meta property="og:locale" content="en_US" /><meta name="description" content="If you work with data, chances are, you came across or worked with a compute cluster of some sorts. There is not a conference, meetup, GitHub repository, or whatnot that doesn’t mention Docker containers and/or their orchestration. If you’ve read some of my blog posts you know that I too, try to develop in and with Docker containers. But I have never actually deployed an application to a compute cluster other than a local setup Docker Swarm. Let’s change that, shall we?" /><meta property="og:description" content="If you work with data, chances are, you came across or worked with a compute cluster of some sorts. There is not a conference, meetup, GitHub repository, or whatnot that doesn’t mention Docker containers and/or their orchestration. If you’ve read some of my blog posts you know that I too, try to develop in and with Docker containers. But I have never actually deployed an application to a compute cluster other than a local setup Docker Swarm. Let’s change that, shall we?" /><link rel="canonical" href="https://iwpnd.pw//articles/2020-05/part1-docker-swarm-on-ec2-initial-setup" /><meta property="og:url" content="https://iwpnd.pw//articles/2020-05/part1-docker-swarm-on-ec2-initial-setup" /><meta property="og:site_name" content="iwpnd" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-13T11:37:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Docker Swarm on AWS EC2 Part 1: Initial provisioning and setup" /><meta name="twitter:site" content="@imwithpanda" /><meta name="twitter:creator" content="@imwithpanda" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"iwpnd"},"dateModified":"2020-05-13T11:37:00+00:00","datePublished":"2020-05-13T11:37:00+00:00","description":"If you work with data, chances are, you came across or worked with a compute cluster of some sorts. There is not a conference, meetup, GitHub repository, or whatnot that doesn’t mention Docker containers and/or their orchestration. If you’ve read some of my blog posts you know that I too, try to develop in and with Docker containers. But I have never actually deployed an application to a compute cluster other than a local setup Docker Swarm. Let’s change that, shall we?","headline":"Docker Swarm on AWS EC2 Part 1: Initial provisioning and setup","mainEntityOfPage":{"@type":"WebPage","@id":"https://iwpnd.pw//articles/2020-05/part1-docker-swarm-on-ec2-initial-setup"},"url":"https://iwpnd.pw//articles/2020-05/part1-docker-swarm-on-ec2-initial-setup"}</script><title> Docker Swarm on AWS EC2 Part 1&amp;#58; Initial provisioning and setup - iwpnd</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="iwpnd" href="/atom.xml"><link rel="alternate" type="application/json" title="iwpnd" href="https://iwpnd.pw//feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.highlight{background:#282a36;color:#f8f8f2;font-size:.8rem}.highlight .hll,.highlight .s,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .dl,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx,.highlight .sr,.highlight .s1,.highlight .ss{color:#f1fa8c}.highlight .go{color:#44475a}.highlight .err,.highlight .g,.highlight .l,.highlight .n,.highlight .x,.highlight .p,.highlight .ge,.highlight .gr,.highlight .gh,.highlight .gi,.highlight .gp,.highlight .gs,.highlight .gu,.highlight .gt,.highlight .ld,.highlight .no,.highlight .nd,.highlight .ni,.highlight .ne,.highlight .nn,.highlight .nx,.highlight .py,.highlight .w,.highlight .bp{color:#f8f8f2}.highlight .gh,.highlight .gi,.highlight .gu{font-weight:bold}.highlight .ge{text-decoration:underline}.highlight .bp{font-style:italic}.highlight .c,.highlight .ch,.highlight .cm,.highlight .cpf,.highlight .c1,.highlight .cs{color:#6272a4}.highlight .kd,.highlight .kt,.highlight .nb,.highlight .nl,.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#8be9fd}.highlight .kd,.highlight .nb,.highlight .nl,.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{font-style:italic}.highlight .na,.highlight .nc,.highlight .nf,.highlight .fm{color:#50fa7b}.highlight .k,.highlight .o,.highlight .cp,.highlight .kc,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .nt,.highlight .ow{color:#ff79c6}.highlight .m,.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#bd93f9}.highlight .gd{color:#f55}</style></head><body><main role="main"><header role="banner"> <img src="/img/iwpnd-logo.png" alt="iwpnd logo"><nav role="navigation"><ul><li><a href="/" >blog</a></li><li><a href="/til" >til</a></li><li><a href="/about" >about</a></li><li><a href="/search" >search</a></li><li><a href="/imprint" >imprint</a></li></ul></nav></header><script async src="https://www.googletagmanager.com/gtag/js?id=UA-156087226-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-156087226-1'); </script><section class="post"><h2>Docker Swarm on AWS EC2 Part 1&#58; Initial provisioning and setup</h2><p>If you work with data, chances are, you came across or worked with a compute cluster of some sorts. There is not a conference, meetup, GitHub repository, or whatnot that doesn’t mention Docker containers and/or their orchestration. If you’ve read some of my blog posts you know that I too, try to develop in and with Docker containers. But I have never actually deployed an application to a compute cluster other than a local setup Docker Swarm. Let’s change that, shall we?</p><h2 id="what-will-we-learn-in-this-series">What will we learn in this series?</h2><p>In this series, we’re going to find answers to some questions like:</p><p>How do I provision and set up an AWS EC2 instance? How do I set up a cluster in the cloud? How do I route my applications? How do I manage my applications How do I even do CI/CD with a Docker Swarm?</p><p>The first part of this series will focus on the initial steps of the setup. Like how to set up a Virtual Private Cloud (VPC) and attach security groups. I will also show how to launch an AWS EC2 instance and do the necessary steps to set up a Docker Swarm on it.</p><p>In the second part of the series I will show how to set up a <a href="https://containo.us/traefik/">Traefik</a> Proxy with HTTPS that will handle incoming connections, expose your services and applications based on their domain name, manage multiple domains, handle and acquire HTTPS certificates with <a href="https://letsencrypt.org/">Let’s Encrypt</a>. I will also show how to set up <a href="https://www.portainer.io/">Portainer</a>) as the first service.</p><p>Part three will focus on how to deploy services to your Docker Swarm in a CI/CD pipeline using <a href="https://github.com">GitHub</a> and <a href="https://github.com/features/actions">GitHub Actions</a>.</p><h2 id="what-will-i-not-cover-in-this-series">What will I not cover in this series?</h2><p>I love automation. However, what I will not be doing, is showing you how to set up this cluster using Terraform or AWS Cloudformation (yet). I feel doing all of this from scratch, even if you only do it once, will go a long way when it comes to understanding it.</p><h2 id="prerequisites">Prerequisites</h2><p>You will need to have access to the AWS management console. Your user will also need permission to create resources within AWS e.g. a VPC, security groups, EC2 instances. For this exercise, I will be using macOS. Windows users will have to read up on how to set up and ssh into a remote server, e.g. via <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/putty.html">PuTTY</a>.</p><h3 id="virtual-private-cloud">Virtual Private Cloud</h3><p>As Elastic Compute Resources (EC2 Instances) can only be launched inside a <a href="https://aws.amazon.com/vpc/">Virtual Private Cloud (VPC)</a>, we will need a VPC. Accounts older than 04.12.2013 will have to create a <a href="https://aws.amazon.com/vpc/">Virtual Private Cloud (VPC)</a>, as described <a href="https://docs.aws.amazon.com/vpc/latest/userguide/default-vpc.html#create-default-vpc">here</a>. Newer accounts already have a default VPC setup that we can launch the EC2 instance for our Docker Swarm into.</p><h2 id="launch-an-ec2-instance">Launch an EC2 instance</h2><p>With the prerequisites out of the way, we can go ahead and launch our first instance. In the AWS Management Console go to Services &gt; Compute &gt; EC2 and spank that Launch button.</p><h3 id="choose-an-amazon-machine-image-ami">Choose an Amazon Machine Image (AMI)</h3><p>First, you will have to select an AMI to run on your instance. I opted for Amazon Linux 2 AMI (HVM) 64-bit (x86) for no particular reason. It’s free tier eligible, if you still can make use of that, and is built by Amazon to have optimal performance on EC2. You can use another AMI that suits you. Just make sure to adapt things like package management that I will be using in this post to the OS of your choice.</p><h3 id="choose-an-instance-type">Choose an Instance Type</h3><p>Next up, you’re prompted to select an instance type. Now, this is where you can either go all out or start reasonably small. I was planning to use the Docker Swarm cluster for small services that I want to test in a production environment. I do not expect any users, nor do I run computational heavy stuff on it. You can, however, that is up to you and your budget. A <code class="language-plaintext highlighter-rouge">t2.small</code> is roughly 18,00 Euro a month including storage and traffic if it’s running 24/7 on eu-west-1. If you registered an account with AWS because you’re on a learning path, then you will most likely still be eligible for the free tier, which means that <code class="language-plaintext highlighter-rouge">t2.micro</code> instance is free of charge for a year. A <code class="language-plaintext highlighter-rouge">t2.micro</code>, for this tutorial, is all we need.</p><h3 id="configure-your-instance">Configure your Instance</h3><p align="center"> <img src="/img/2020-05-docker-swarm/aws-ec2-config.png" alt="aws ec2 configuration" /></p><p>There is not much to change here. If you’re just starting with your AWS account the Network will be prepopulated with your VPC already. The subnet can also stay on default. We want to, however, <strong>enable</strong> <strong>Auto-assign Public IP</strong>. If you plan to create resources on AWS with this particular EC2 instance, e.g. create an Amazon S3 Bucket, you will need to attach an IAM role to your instance for the proper permissions set up. In our case, we will not create any other resources WITH the EC2 Instance, so we leave that blank. <strong>Stop - Hibernate behavior</strong> is interesting, if you plan on often shutting an instance down if you don’t use it, and bring it back up when you use it. In this case, on <strong>Stop</strong> all your instances Files and RAM will be dumped to an attached file system and you can use this if you bring it up another time to have everything where you left it off. Keep in mind, however, that you will still pay for the attached storage 24/7. Monitoring is also pretty good with CloudWatch. It does come with a cost, however, and since we will utilize <a href="https://containo.us/traefik/">Traefik</a> and <a href="https://www.portainer.io/">Portainer</a>, we will have our monitoring in place. Leave the rest as seen in the Screenshot and continue with <strong>Next: Add Storage</strong>.</p><h3 id="add-storage">Add Storage</h3><p>Pretty much just leave as is, unless you need more storage or have other requirements that you think will not be fulfilled with the default settings. Continue</p><h3 id="add-tags">Add Tags</h3><p>This EC2 instance will function as the Manager Node of your Docker Swarm Cluster that receives commands on behalf of the cluster and assign containers to other Swarm nodes (if you plan on having more than 1). Tags will only help you to distinguish your instance from each other in the AWS Management Console. It will not have an effect on your Instances hostname or whatever. Do yourself a favor and Tag your AWS resources and continue.</p><h3 id="configure-security-group">Configure Security Group</h3><p>An AWS security group acts as a virtual firewall for your AWS resources inside of your VPC. As such it is highly recommended to read up on some best practices for setting up security groups and how to manage each layer of your infrastructure properly using security groups (e.g. <a href="https://www.stratoscale.com/blog/compute/aws-security-groups-5-best-practices/">best practices</a>, <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-security-groups.html">AWS intro on security groups</a>). For this demo, we need to set up a security group that is open to inbound traffic from a couple of ports and protocols. You can set it up right now or in the Management Console go to Services &gt; search for VPC &gt; under Security go to Security Groups and hit Create Security Group. Give it a significant name and description add inbound rules for:</p><table><thead><tr><th>Protocol</th><th>Port</th><th>Source</th></tr></thead><tbody><tr><td>TCP</td><td>2377</td><td>0.0.0.0/0</td></tr><tr><td>TCP</td><td>7946</td><td>0.0.0.0/0</td></tr><tr><td>TCP</td><td>8501</td><td>0.0.0.0/0</td></tr><tr><td>UDP</td><td>4789</td><td>0.0.0.0/0</td></tr><tr><td>UDP</td><td>7946</td><td>0.0.0.0/0</td></tr><tr><td>SSH</td><td>7946</td><td>0.0.0.0/0</td></tr><tr><td>HTTPS</td><td>443</td><td>0.0.0.0/0</td></tr><tr><td>HTTP</td><td>80</td><td>0.0.0.0/0</td></tr></tbody></table><p>Now make sure to attach the newly created security group to your instance and continue.</p><h3 id="review-your-instance-and-launch">Review your instance and launch</h3><p align="center"> <img src="/img/2020-05-docker-swarm/aws-ec2-config-keypair.png" alt="aws ec2 configuration keypair" /></p><p>Upon launch, you will be asked to create a keypair, a <strong>private</strong> key, and a <strong>public</strong> key. AWS EC2 uses public-key cryptography to encrypt and decrypt login information and therefore allows you to access your instance using a private key instead of a password. For a detailed description of the concept of Public Key Authentification, I refer you to <a href="https://www.ssh.com/ssh/public-key-authentication">ssh.com</a>. AWS will ask you to name and create a key pair. The private key will be stored in a <code class="language-plaintext highlighter-rouge">.pem</code> file and should be downloaded to a secure location on your local file system or trusted storage of your choice. I store it in <code class="language-plaintext highlighter-rouge">~/.ssh/</code>. If you create an EC2 instance only this file/this key will let you access it. AWS does not store a duplicate it anywhere, so if you have lost it, you lost it and you will have to shut down your instance for good. The other part, the public key, will be stored on your Linux EC2 instance in <code class="language-plaintext highlighter-rouge">~/.ssh/authorized_keys</code>.</p><h2 id="congratulations-you-just-set-up-your-first-ec2-instance">Congratulations, you just set up your first EC2 instance</h2><p>Now open a terminal, you will need it from now on.</p><h3 id="configure-ssh-to-access-your-instance">Configure SSH to access your instance</h3><p>For convenience’s sake, I create a <code class="language-plaintext highlighter-rouge">~/.ssh/config</code> file and store my remote instances information there for easy access from the terminal.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim ~/.ssh/config
</code></pre></div></div><p align="center"> <img src="/img/2020-05-docker-swarm/aws-ec2-ssh-config.png" alt="aws ec2 configuration keypair" /></p><p>For your hostname, you will set up the Public DNS (IPv4) of your EC2 instance. The <strong>User</strong> depends on your OS. Fox Amazon Linux 2 it’s <code class="language-plaintext highlighter-rouge">ec2-user</code>, for other AMIs you can look up the default user <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/connection-prereqs.html">here</a>. Your <strong>IdentityFile</strong> will be the <code class="language-plaintext highlighter-rouge">.pem</code> file with your private key you downloaded earlier. Save and close the file <code class="language-plaintext highlighter-rouge">:wq!</code>.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh swarm
</code></pre></div></div><p align="center"> <img src="/img/2020-05-docker-swarm/aws-ec2-ssh.png" alt="ssh into AWS EC2" /></p><h3 id="change-your-instances-hostname">Change your Instances hostname</h3><p>First, we will change the hostname of the instance using a subdomain of a domain you plan on using for your swarm. Changing the hostname will require you to reboot your instance. Don’t worry, if you’re only in it for this part of the tutorial and only want to set up your first swarm for the lulz, you can skip this step.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>hostnamectl set-hostname webserver.mydomain.com
<span class="nb">sudo </span>reboot
</code></pre></div></div><p>Wait for your instance to reboot, ssh back in, and check the result using <code class="language-plaintext highlighter-rouge">echo $HOSTNAME</code>.</p><h3 id="install-and-setup-docker">Install and setup Docker</h3><p>Now, this part comes down to the OS you chose for your AMI. Amazon Linux 2 AMI uses <code class="language-plaintext highlighter-rouge">yum</code> package manager. Adapt the next steps to your chosen OS.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># update </span>
<span class="nb">sudo </span>yum update

<span class="c"># install docker </span>
<span class="nb">sudo </span>yum <span class="nb">install </span>docker

<span class="c"># start docker</span>
<span class="nb">sudo </span>service docker start

<span class="c"># check if its installed properly</span>
docker <span class="nt">--version</span>

<span class="c"># add ec2-user to docker group to allow docker commands without sudo</span>
<span class="nb">sudo </span>usermod <span class="nt">-a</span> <span class="nt">-G</span> docker ec2-user

<span class="c"># add docker to autostart and reboot to see if it's working</span>
<span class="nb">sudo </span>chkconfig docker on
<span class="nb">sudo </span>reboot

<span class="c"># test user rights and autostart</span>
docker version
</code></pre></div></div><h3 id="init-your-docker-swarm">Init your Docker swarm</h3><p>With the setup of Docker out of the way, we can finally initiate our Docker Swarm.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker swarm init
</code></pre></div></div><p>This will greet you with this:</p><p align="center"> <img src="/img/2020-05-docker-swarm/aws-ec2-docker-swarm-init.png" alt="Docker swarm init" /></p><p>If you want to add another node to your cluster, you can go back to the AWS Management Console, and do all of this again. If that EC2 instance is ready and docker installed, you can just use the command in the screenshot above to join this new instance to your Docker swarm as a worker node. Now you can check the nodes in your swarm via:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker node <span class="nb">ls</span>
</code></pre></div></div><p align="center"> <img src="/img/2020-05-docker-swarm/aws-ec2-docker-swarm-node-ls.png" alt="Docker swarm init" /></p><p>As you can see I only have set up a single node, which is my leading node - the manager.</p><p>Congratulations! You just set up your first Docker Swarm on AWS EC2!</p><p>The next part will focus on how to setup <a href="https://containo.us/traefik/">Traefik</a> and <a href="https://www.portainer.io/">Portainer</a>) to handle connections in your cluster, manage HTTPS certificates and routing as well as monitoring your Docker Swarm.</p><span class="meta"><time datetime="2020-05-13T11:37:00+00:00">May 13, 2020</time> &middot; <a href="/tag/docker">docker</a>, <a href="/tag/swarm">swarm</a>, <a href="/tag/aws ec2">aws ec2</a></span></section></main></body></html>
