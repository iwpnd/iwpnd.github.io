<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="docker-compose in monorepos" /><meta name="author" content="iwpnd" /><meta property="og:locale" content="en_US" /><meta name="description" content="geographer turned data engineer turned backend developer" /><meta property="og:description" content="geographer turned data engineer turned backend developer" /><link rel="canonical" href="https://iwpnd.pw//articles/2021-05/docker-compose-in-monorepos" /><meta property="og:url" content="https://iwpnd.pw//articles/2021-05/docker-compose-in-monorepos" /><meta property="og:site_name" content="iwpnd" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-05T11:37:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="docker-compose in monorepos" /><meta name="twitter:site" content="@imwithpanda" /><meta name="twitter:creator" content="@imwithpanda" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"iwpnd"},"dateModified":"2021-05-05T11:37:00+00:00","datePublished":"2021-05-05T11:37:00+00:00","description":"geographer turned data engineer turned backend developer","headline":"docker-compose in monorepos","mainEntityOfPage":{"@type":"WebPage","@id":"https://iwpnd.pw//articles/2021-05/docker-compose-in-monorepos"},"url":"https://iwpnd.pw//articles/2021-05/docker-compose-in-monorepos"}</script><title> docker-compose in monorepos - iwpnd</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="iwpnd" href="/atom.xml"><link rel="alternate" type="application/json" title="iwpnd" href="https://iwpnd.pw//feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.highlight{background:#282a36;color:#f8f8f2;font-size:.8rem}.highlight .hll,.highlight .s,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .dl,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx,.highlight .sr,.highlight .s1,.highlight .ss{color:#f1fa8c}.highlight .go{color:#44475a}.highlight .err,.highlight .g,.highlight .l,.highlight .n,.highlight .x,.highlight .p,.highlight .ge,.highlight .gr,.highlight .gh,.highlight .gi,.highlight .gp,.highlight .gs,.highlight .gu,.highlight .gt,.highlight .ld,.highlight .no,.highlight .nd,.highlight .ni,.highlight .ne,.highlight .nn,.highlight .nx,.highlight .py,.highlight .w,.highlight .bp{color:#f8f8f2}.highlight .gh,.highlight .gi,.highlight .gu{font-weight:bold}.highlight .ge{text-decoration:underline}.highlight .bp{font-style:italic}.highlight .c,.highlight .ch,.highlight .cm,.highlight .cpf,.highlight .c1,.highlight .cs{color:#6272a4}.highlight .kd,.highlight .kt,.highlight .nb,.highlight .nl,.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#8be9fd}.highlight .kd,.highlight .nb,.highlight .nl,.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{font-style:italic}.highlight .na,.highlight .nc,.highlight .nf,.highlight .fm{color:#50fa7b}.highlight .k,.highlight .o,.highlight .cp,.highlight .kc,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .nt,.highlight .ow{color:#ff79c6}.highlight .m,.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#bd93f9}.highlight .gd{color:#f55}</style></head><body><main role="main"><header role="banner"> <img src="/img/iwpnd-logo.png" alt="iwpnd logo"><nav role="navigation"><ul><li><a href="/" >blog</a></li><li><a href="/til" >til</a></li><li><a href="/about" >about</a></li><li><a href="/search" >search</a></li><li><a href="/imprint" >imprint</a></li></ul></nav></header><script async src="https://www.googletagmanager.com/gtag/js?id=UA-156087226-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-156087226-1'); </script><section class="post"><h2>docker-compose in monorepos</h2><p align="center"> <img src="/img/2021-05-05-docker-compose/docker-compose-monorepos.png" alt="docker-compose-monorepos" /></p><h2 id="monorepo">Monorepo</h2><p>As I was joining TIER Mobility not only did I have to learn TypeScript quickly, but I also had to learn how to work with a monorepo - something that first felt weird, but I got to love quickly. The idea is that instead of having a package for every one of your services with its pre-commit hooks, lint setups, prettier configs, ci/cd pipelines, and whatnot, every service is instead a package in a single repository that is being orchestrated with yarn and Lerna. They share the same configurations, the same dependabot that keeps them up to date and you can even reference them from within each other. Do you have a <code class="language-plaintext highlighter-rouge">logger</code> that is used in all of your services? Have it as a package in the monorepo and import it in your other services.</p><h2 id="local-development-environment">Local development environment</h2><p>One way or another you will want to have your development environment mirror your deployment environment. For that purpose, and because it comes shipped alongside Docker, you will probably use <code class="language-plaintext highlighter-rouge">docker compose</code> CLI and <code class="language-plaintext highlighter-rouge">up</code> your stack like that. In our monorepo, we started with a single <code class="language-plaintext highlighter-rouge">docker-compose.yaml</code> at the top level of our monorepo. We have our database, our Redis, and maybe something like RabbitMQ, that we tend to use across our stack consistently. All good and fine.</p><h2 id="until">Until..</h2><p>Our monorepo grew, and so did our stack.</p><p>There we had a <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> that up RabbitMQ, Tile38, Redis, some databases, and Kafka - a stack that brings even the biggest machine to hold (if you run <a href="https://lofi.cafe">lofi.cafe</a>) next to it. So instead of having a single <code class="language-plaintext highlighter-rouge">docker-compose.yml</code>, I created a file for each service within its package to only start what the service needed. Yarns task runner is pretty useful to set up each respective <code class="language-plaintext highlighter-rouge">package.json</code> with a <code class="language-plaintext highlighter-rouge">up</code>/<code class="language-plaintext highlighter-rouge">down</code> script.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "name": "my-service",
  "scripts": {
    "lint": "eslint --ext .ts src",
    "test": "jest --testMatch '**/*.test.ts'",
    "up": "docker compose up",
    "down": "docker compose down"
  }
}
</code></pre></div></div><p>Now if you work on a service, you can use <code class="language-plaintext highlighter-rouge">yarn workspace my-service up</code> to start the development environment with the dependencies you need for your service, and not those of your monorepo.</p><h2 id="there-is-one-more-thing">There is one more thing</h2><p>This is already pretty helpful. However, something like Redis is more often used than not. That means that</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  redis:
    image: redis:6.2.3
    ports:
      - 6379:6379
</code></pre></div></div><p>occurs in almost every <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> across the entire monorepo. That means duplication, and you will have to make sure that the version is updated. So instead of duplicating a Redis service in every <code class="language-plaintext highlighter-rouge">docker-compose</code> file, <strong>today I learned</strong> that <a href="https://docs.docker.com/compose/extends/">compose configurations can be shared across file and projects</a>.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// monorepo/docker-compose.yml
version: "3"

services:
  redis:
    image: redis:5.0.6
    ports:
      - 6379:6379

  (...) // other shared dependencies
</code></pre></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// monorepo/packages/my-service/docker-compose.yml
version: "3"

services:
  redis:
    extends:
      file: ../../docker-compose.yml
      service: redis

  (...) // other service dependencies
</code></pre></div></div><p>In this setup, Redis is added to the top-level <code class="language-plaintext highlighter-rouge">docker-compose</code> file and is extended in the services <code class="language-plaintext highlighter-rouge">docker-compose</code> file. If we now up the service with <code class="language-plaintext highlighter-rouge">yarn workspace my-service up</code> it will check for Redis in the top-level up it, and continue to add the dependencies as they are defined in the services <code class="language-plaintext highlighter-rouge">docker-compose</code>.</p><p>Do this sooner than later, and your monorepo is on course to grow indefinitely.</p><span class="meta"><time datetime="2021-05-05T11:37:00+00:00">May 5, 2021</time> &middot; <a href="/tag/til">til</a>, <a href="/tag/monorepo">monorepo</a>, <a href="/tag/docker">docker</a>, <a href="/tag/docker compose">docker compose</a></span></section></main></body></html>
