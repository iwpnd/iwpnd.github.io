<!DOCTYPE html><html lang="en" ><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="pyle38 - An async python client for Tile38" /><meta name="author" content="iwpnd" /><meta property="og:locale" content="en_US" /><meta name="description" content="geographer turned data engineer turned backend developer" /><meta property="og:description" content="geographer turned data engineer turned backend developer" /><link rel="canonical" href="https://iwpnd.pw//articles/2021-07/pyle38-tile38-python-client" /><meta property="og:url" content="https://iwpnd.pw//articles/2021-07/pyle38-tile38-python-client" /><meta property="og:site_name" content="iwpnd" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-31T11:37:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="pyle38 - An async python client for Tile38" /><meta name="twitter:site" content="@imwithpanda" /><meta name="twitter:creator" content="@imwithpanda" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"iwpnd"},"dateModified":"2021-07-31T11:37:00+00:00","datePublished":"2021-07-31T11:37:00+00:00","description":"geographer turned data engineer turned backend developer","headline":"pyle38 - An async python client for Tile38","mainEntityOfPage":{"@type":"WebPage","@id":"https://iwpnd.pw//articles/2021-07/pyle38-tile38-python-client"},"url":"https://iwpnd.pw//articles/2021-07/pyle38-tile38-python-client"}</script><title> pyle38 - An async python client for Tile38 - iwpnd</title><link rel="shortcut icon" href="/favicon.png"><link rel="alternate" type="application/atom+xml" title="iwpnd" href="/atom.xml"><link rel="alternate" type="application/json" title="iwpnd" href="https://iwpnd.pw//feed.json" /><link rel="sitemap" type="application/xml" title="sitemap" href="/sitemap.xml" /><style> *,:after,:before{box-sizing:border-box;background-color:inherit;color:inherit;margin:0;padding:0}body{font-family:system-ui, sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;line-height:1.5;font-size:1rem;color:#16171a}nav ul{border-right:1px solid #edf2f7}a{color:#000;text-decoration-skip-ink:auto;text-decoration:underline}pre{margin:.5rem 0;padding:.5rem}.post p{margin:.5rem 0}.post h1,.post h2,.post h3,.post h4{margin:1rem 0}.post h2:first-child,.project h2:first-child,.photo h2:first-child{margin-top:0}.meta{margin:2rem 0}code{padding:.1rem}pre code{border:none}pre{padding:1rem;overflow-x:auto}img{max-width:100%}hr{background:#000;height:1px;border:0}header{flex-basis:10rem;flex-grow:1;position:relative}header a{text-decoration:none}header li{margin-bottom:.2rem;text-align:right;margin-right:2rem}header a.active{font-weight:bold}header,section{padding:1rem}blockquote{font-style:italic;border-left:5px solid #ececec;padding-left:1rem}h1,h2,h3,h4,h5{line-height:1;margin:1rem 0;font-weight:600}section h1:first-child{margin-top:0}strong,b{font-weight:bold}.photos ul{list-style:none}.photos li{margin-bottom:1.5rem}.photo picture,.project picture{margin-bottom:0.5rem}.posts ul,header ul{list-style:none}.posts li{align-items:center;display:flex;justify-content:space-between;margin-bottom:.5rem}.posts li a,.posts li div,.projects li a{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.posts li time,.projects li time{padding-left:1rem;white-space:nowrap;font-variant-numeric:tabular-nums}main{display:flex;flex-wrap:wrap;max-width:60rem;margin:2rem auto;padding:1rem}@media screen and (max-width: 45rem){header li{display:inline;margin-right:1rem}.logo{padding-bottom:1rem}header ul{border-bottom:1px solid #edf2f7;padding-bottom:2rem}nav ul{border-right:0px}.photos ul{margin-top:0.5rem}}section{flex-basis:0;flex-grow:999;min-width:70%;display:flex;flex-direction:column}figcaption{font-size:smaller}.highlight{background:#282a36;color:#f8f8f2;font-size:.8rem}.highlight .hll,.highlight .s,.highlight .sa,.highlight .sb,.highlight .sc,.highlight .dl,.highlight .sd,.highlight .s2,.highlight .se,.highlight .sh,.highlight .si,.highlight .sx,.highlight .sr,.highlight .s1,.highlight .ss{color:#f1fa8c}.highlight .go{color:#44475a}.highlight .err,.highlight .g,.highlight .l,.highlight .n,.highlight .x,.highlight .p,.highlight .ge,.highlight .gr,.highlight .gh,.highlight .gi,.highlight .gp,.highlight .gs,.highlight .gu,.highlight .gt,.highlight .ld,.highlight .no,.highlight .nd,.highlight .ni,.highlight .ne,.highlight .nn,.highlight .nx,.highlight .py,.highlight .w,.highlight .bp{color:#f8f8f2}.highlight .gh,.highlight .gi,.highlight .gu{font-weight:bold}.highlight .ge{text-decoration:underline}.highlight .bp{font-style:italic}.highlight .c,.highlight .ch,.highlight .cm,.highlight .cpf,.highlight .c1,.highlight .cs{color:#6272a4}.highlight .kd,.highlight .kt,.highlight .nb,.highlight .nl,.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{color:#8be9fd}.highlight .kd,.highlight .nb,.highlight .nl,.highlight .nv,.highlight .vc,.highlight .vg,.highlight .vi,.highlight .vm{font-style:italic}.highlight .na,.highlight .nc,.highlight .nf,.highlight .fm{color:#50fa7b}.highlight .k,.highlight .o,.highlight .cp,.highlight .kc,.highlight .kn,.highlight .kp,.highlight .kr,.highlight .nt,.highlight .ow{color:#ff79c6}.highlight .m,.highlight .mb,.highlight .mf,.highlight .mh,.highlight .mi,.highlight .mo,.highlight .il{color:#bd93f9}.highlight .gd{color:#f55}</style></head><body><main role="main"><header role="banner"> <img src="/img/iwpnd-logo.png" alt="iwpnd logo"><nav role="navigation"><ul><li><a href="/" >blog</a></li><li><a href="/til" >til</a></li><li><a href="/about" >about</a></li><li><a href="/search" >search</a></li><li><a href="/imprint" >imprint</a></li></ul></nav></header><script async src="https://www.googletagmanager.com/gtag/js?id=UA-156087226-1"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-156087226-1'); </script><section class="post"><h2>pyle38 - An async python client for Tile38</h2><p align="center"> <img src="/img/2021-07-31-pyle38/pyle38.png" alt="pyle38" /></p><p>Back in May I wrote an introductory blog post about <a href="https://iwpnd.pw/articles/2021-04/Tile38-in-memory-geodatabase">Tile38</a>. Professionally I work with Tile38 in a TypeScript eco-system. Together with a colleague I authored a TypeScript client that is now used internally - and hopefully soon to be released to the public. As there was also no client for Python either yet, and due to the pandemic, there was more free time than usual on my hand I wrote one myself.</p><h2 id="introducing-pyle38">Introducing Pyle38</h2><p>Pyle38 is a lazy asynchonous Python client for Tile38 that allows for fast and easy interaction with the worlds fastest in-memory geodatabase <a href="https://tile38.com">Tile38</a> build on top of the re-designed <a href="https://aioredis.readthedocs.io/en/latest/migration/">aioredis 2.0.0</a>. Even though the Python community is only slowly adapting type hints into Python, I made sure that Pyle38 is already fully typed and passes <a href="http://mypy-lang.org/">mypy</a> validation. <a href="https://pydantic-docs.helpmanual.io/">Pydantic</a> is used to enforce those type hints at runtime.</p><h2 id="feature-command-chaining">Feature: Command chaining</h2><p>Tile38 provides a lot of options for its queries, configs and insert commands.</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WITHIN fleet LIMIT 10 NOFIELDS IDS CIRCLE 52.25 13.37 1000
</code></pre></div></div><p>Returns the ids of 10 objects in the <code class="language-plaintext highlighter-rouge">fleet</code> collection in a radius of 1000 around a point with latitude 52.25 and longitude 13.37. The order of the the commands and options is fixed, putting the <code class="language-plaintext highlighter-rouge">LIMIT 10</code> at the end of the command would result in an error.</p><p>The same query in pyle38 would look like this:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">tile38</span><span class="p">.</span><span class="n">within</span><span class="p">(</span><span class="s">'fleet'</span><span class="p">).</span><span class="n">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="n">nofields</span><span class="p">().</span><span class="n">circle</span><span class="p">(</span><span class="mf">52.25</span><span class="p">,</span> <span class="mf">13.37</span><span class="p">,</span> <span class="mi">1000</span><span class="p">).</span><span class="n">asIds</span><span class="p">()</span>
</code></pre></div></div><p>The order of the commands in pyle38 can, but does not have to be exactly as required in Tile38. Commands can be chained to the users liking and pyle38 will take care that the order is correct when the command is passed to Tile38.</p><h2 id="feature-fully-asynchronous">Feature: fully asynchronous</h2><p>Pyle38 methods are almost entirely asynchronous. Why? For one I wanted to learn how to do it. On the other hand the application I had in mind for Pyle38/Tile38 was as a backend for a <a href="https://fastapi.tiangolo.com/">FastAPI</a> app.</p><h2 id="feature-leaderfollower-replication">Feature: Leader/Follower replication</h2><p>Tile38 supports <a href="https://iwpnd.pw/articles/2021-04/Tile38-in-memory-geodatabase#leader-and-follower-replication">leader/follower replication</a> and so does Pyle38. Pyle38 allows to instantiate two clients at once; one for the leader and another one for a follower. That allows to let writes be handled by the leader and reads by the follower. Currently only one follower uri is supported. The reason is, that ideally you think of how to spread the query load across all followers. Now this can be done on the client, but it would a load balancer will probably do a better job.</p><h2 id="basic-usage">Basic Usage</h2><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">pyle38</span> <span class="kn">import</span> <span class="n">Tile38</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">tile38</span> <span class="o">=</span> <span class="n">Tile38</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">"redis://localhost:9851"</span><span class="p">,</span> <span class="n">follower_url</span><span class="o">=</span><span class="s">"redis://localhost:9851"</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">tile38</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">"fleet"</span><span class="p">,</span> <span class="s">"truck"</span><span class="p">).</span><span class="n">point</span><span class="p">(</span><span class="mf">52.25</span><span class="p">,</span><span class="mf">13.37</span><span class="p">).</span><span class="k">exec</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tile38</span><span class="p">.</span><span class="n">follower</span><span class="p">()</span>
        <span class="p">.</span><span class="n">within</span><span class="p">(</span><span class="s">"fleet"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">circle</span><span class="p">(</span><span class="mf">52.25</span><span class="p">,</span> <span class="mf">13.37</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">.</span><span class="n">asObjects</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">response</span><span class="p">.</span><span class="n">ok</span>

    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="nb">dict</span><span class="p">())</span>

<span class="n">asyncio</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>

<span class="o">&gt;</span> <span class="p">{</span>
    <span class="s">"ok"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="s">"elapsed"</span><span class="p">:</span> <span class="s">"48.8µs"</span><span class="p">,</span>
    <span class="s">"objects"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s">"object"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"type"</span><span class="p">:</span> <span class="s">"Point"</span><span class="p">,</span>
                <span class="s">"coordinates"</span><span class="p">:</span> <span class="p">[</span>
                    <span class="mf">13.37</span><span class="p">,</span>
                    <span class="mf">52.25</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="s">"id"</span><span class="p">:</span> <span class="s">"truck"</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s">"count"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">"cursor"</span><span class="p">:</span> <span class="mi">0</span>
<span class="p">}</span>
</code></pre></div></div><p>Let’s go and dissect this example.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tile38</span> <span class="o">=</span> <span class="n">Tile38</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">"redis://localhost:9851"</span><span class="p">,</span> <span class="n">follower_url</span><span class="o">=</span><span class="s">"redis://localhost:9851"</span><span class="p">)</span>
</code></pre></div></div><p>At First, an instance of Tile38 is created. Optionally a follower url can be passed to Tile38 in the constructor, that will create a both a client for the leader, as well as the follower.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="n">tile38</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="s">"fleet"</span><span class="p">,</span> <span class="s">"truck"</span><span class="p">).</span><span class="n">point</span><span class="p">(</span><span class="mf">52.25</span><span class="p">,</span><span class="mf">13.37</span><span class="p">).</span><span class="k">exec</span><span class="p">()</span>
</code></pre></div></div><p>Now we add an object with the name <code class="language-plaintext highlighter-rouge">truck</code> to the <code class="language-plaintext highlighter-rouge">fleet</code> collection as a point with latitude 52.25 and longitude 13.37. <code class="language-plaintext highlighter-rouge">SET</code>’s have to be executed specifically with <code class="language-plaintext highlighter-rouge">.exec()</code>.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">tile38</span><span class="p">.</span><span class="n">follower</span><span class="p">()</span>
        <span class="p">.</span><span class="n">within</span><span class="p">(</span><span class="s">"fleet"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">circle</span><span class="p">(</span><span class="mf">52.25</span><span class="p">,</span> <span class="mf">13.37</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="p">.</span><span class="n">asObjects</span><span class="p">()</span>
</code></pre></div></div><p>As there is now an object in the fleet collection. The user can now send a query to Tile38. The <code class="language-plaintext highlighter-rouge">.follower()</code> method indicates that the query should specifically be send to the follower instance of Tile38. If <code class="language-plaintext highlighter-rouge">follower()</code> is omitted, the query is send to the leader instance instead. <code class="language-plaintext highlighter-rouge">.within('fleet')</code> searches a collection for objects that are fully contained within a given bounding area. The bounding area that is provided in this query is a <code class="language-plaintext highlighter-rouge">.circle(52.25, 13.37, 1000)</code> with a radius of <code class="language-plaintext highlighter-rouge">1000</code> around the coordinates <code class="language-plaintext highlighter-rouge">52.25</code> and <code class="language-plaintext highlighter-rouge">13.37</code>.</p><h2 id="get-it-now">Get it now</h2><p>You can download pyle38 via <code class="language-plaintext highlighter-rouge">pip install pyle38</code> or if Python is not your thing, you can check our other officially supported <a href="https://tile38.com/topics/client-libraries">Tile38 clients</a>.</p><span class="meta"><time datetime="2021-07-31T11:37:00+00:00">July 31, 2021</time> &middot; <a href="/tag/tile38">tile38</a>, <a href="/tag/database">database</a>, <a href="/tag/geodata">geodata</a>, <a href="/tag/pyle38">pyle38</a>, <a href="/tag/python">python</a>, <a href="/tag/async">async</a></span></section></main></body></html>
